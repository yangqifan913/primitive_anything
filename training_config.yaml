# 3Dç‰©ä½“æ£€æµ‹ç»Ÿä¸€é…ç½®æ–‡ä»¶
# åŒ…å«æ‰€æœ‰è®­ç»ƒã€æ¨¡å‹ã€æ•°æ®ã€æŸå¤±å‚æ•°ï¼Œé¿å…é‡å¤
version: '2.0'

# =============================================================================
# å…¨å±€è®¾ç½® - æ‰€æœ‰å…¶ä»–éƒ¨åˆ†å…±äº«çš„åŸºç¡€å‚æ•°
# =============================================================================
global:
  max_seq_len: 12        # æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆåŒæ—¶ç”¨äºæ¨¡å‹å’Œæ•°æ®ï¼‰
  pad_id: -1.0           # å¡«å……å€¼ï¼ˆæ‰€æœ‰æ¨¡å—ç»Ÿä¸€ï¼‰
  image_size: [640, 640] # å›¾åƒå°ºå¯¸ï¼ˆè¾“å…¥å’Œæ•°æ®å¤„ç†ï¼‰
  device: "cuda"         # è®­ç»ƒè®¾å¤‡
  seed: 42               # éšæœºç§å­
  
  # è®­ç»ƒè¿è¡Œå‚æ•°
  logging:
    log_interval: -1           # -1è¡¨ç¤ºæ¯ä¸ªepochåªæ‰“å°ä¸€æ¬¡æ±‡æ€»æ—¥å¿—
    save_interval: 10          # æ£€æŸ¥ç‚¹ä¿å­˜é—´éš”
    validation_samples: [0, 1, 2, 3, 4]  # éªŒè¯æ ·æœ¬ID
  
  # å¯è§†åŒ–å‚æ•°
  visualization:
    distance_threshold: 10.0   # å¯è§†åŒ–è·ç¦»é˜ˆå€¼
    coordinate_threshold: 50   # åæ ‡è¿‡æ»¤é˜ˆå€¼
    box_color: [0, 255, 0]    # æ¡†é¢œè‰² (RGB)

# =============================================================================
# è®­ç»ƒé…ç½® - è®­ç»ƒæµç¨‹å’Œç­–ç•¥
# =============================================================================
training:
  # è®­ç»ƒé˜¶æ®µé…ç½®
  phases:
    teacher_forcing:
      epochs: 120
      teacher_forcing_ratio: 1.0
      scheduled_sampling: false
      sampling_strategy: "none"
      description: "å®Œå…¨Teacher Forcingé˜¶æ®µ"
    
    scheduled_sampling:
      epochs: 120 
      teacher_forcing_ratio: 1.0  # ä»1.0è¡°å‡åˆ°0
      scheduled_sampling: true
      sampling_strategy: "inverse_sigmoid"
      description: "Scheduled Samplingè¿‡æ¸¡é˜¶æ®µ"
    
    pure_generation:
      epochs: 260
      teacher_forcing_ratio: 0.0
      scheduled_sampling: false
      sampling_strategy: "none"
      description: "çº¯ç”Ÿæˆé˜¶æ®µ"
  
  # ä¼˜åŒ–å™¨é…ç½®
  optimizer:
    type: "AdamW"
    lr: 0.0001
    betas: [0.9, 0.999]
    eps: 0.00000001
    weight_decay: 0.05
  
  # å­¦ä¹ ç‡è°ƒåº¦
  scheduler:
    type: "CosineAnnealingLR"
    T_max: 400  # æ€»epochæ•°
    eta_min: 0.000001
  
  # è®­ç»ƒä¼˜åŒ–
  optimizations:
    early_stopping:
      enabled: true
      patience: 10
      min_delta: 0.001
      eos_threshold: 0.5
      adaptive_sequence_length: true
    gradient_clipping:
      enabled: true
      max_norm: 1.0
    mixed_precision:
      enabled: true
      loss_scale: "dynamic"
    torch_compile:
      enabled: false
      mode: "default"
    cudnn_optimizations:
      benchmark: true
      deterministic: false
    incremental_inference:
      enabled: true        # å¯ç”¨å¢é‡æ¨ç†ï¼ˆæ¨èï¼‰
      temperature: 0.5     # Gumbel Softmaxæ¸©åº¦ï¼ˆè®­ç»ƒæ—¶æ¢¯åº¦ä¼ æ’­ï¼Œé™ä½ä»¥èŠ‚çœæ˜¾å­˜ï¼‰
      memory_efficient: true  # å¯ç”¨å†…å­˜ä¼˜åŒ–æ¨¡å¼
    best_model_testing:
      enabled: true        # åœ¨è·å¾—æœ€ä½³æ¨¡å‹æ—¶åœ¨testé›†ä¸Šè¿›è¡Œæ¨ç†
      save_results: true   # ä¿å­˜testç»“æœåˆ°SwanLab

# =============================================================================
# æ¨¡å‹é…ç½® - ç½‘ç»œæ¶æ„
# =============================================================================
model:
  name: "PrimitiveTransformer3DComplex"
  version: "1.0"
  
  # è¾“å…¥é…ç½®
  input:
    channels: 6  # RGBXYZ
  
  # å›¾åƒç¼–ç å™¨
  image_encoder:
    backbone: "resnet50"
    pretrained: true
    use_fpn: true
    fpn_output_channels: 128
    output_dim: 256
    
    # FPNè¯¦ç»†é…ç½®
    fpn:
      attention_layers: [2, 3]  # åœ¨layer3å’Œlayer4ä½¿ç”¨æ³¨æ„åŠ› (i >= 2)
      attention_heads: 8        # æ³¨æ„åŠ›å¤´æ•°
      smooth_conv_kernel: 3     # å¹³æ»‘å·ç§¯æ ¸å¤§å°
      smooth_conv_padding: 1    # å¹³æ»‘å·ç§¯å¡«å……
    
    # ResNet Conv1é…ç½®
    conv1:
      out_channels: 64
      kernel_size: 7
      stride: 2
      padding: 3
      bias: false
  
  # Transformeræ¶æ„
  transformer:
    dim: 512
    depth: 6
    heads: 8
    dim_head: 64
    attn_dropout: 0.1
    ff_dropout: 0.1
      #use_rotary_emb: true
      #rotary_emb_dim: 32
  
  # ç¦»æ•£åŒ–é…ç½®
  discretization:
    num_discrete_x: 128
    num_discrete_y: 128
    num_discrete_z: 128
    num_discrete_w: 64
    num_discrete_h: 64
    num_discrete_l: 64
  
  # åµŒå…¥ç»´åº¦
  embeddings:
    dim_x_embed: 64
    dim_y_embed: 64
    dim_z_embed: 64
    dim_w_embed: 64
    dim_h_embed: 64
    dim_l_embed: 64
  
  # æ¡ä»¶åŒ–é…ç½®
  conditioning:
    condition_on_image: true
    image_film_cond: true
      #use_self_cond: false
      #self_cond_prob: 0.5
  
  # é«˜çº§é…ç½®
  advanced:
    use_gateloop: true
    gateloop_use_heinsen: false
    
    # GateLoopè¯¦ç»†é…ç½®
    gateloop:
      depth: 2                  # GateLoopå±‚æ•°
    
    # ä½ç½®ç¼–ç é…ç½®
    positional_encoding:
      # 2Dä½ç½®ç¼–ç  (ç”¨äºå›¾åƒç‰¹å¾)
      pos_2d:
        base: 10000             # æ­£å¼¦ç¼–ç åº•æ•°
        dim_divisor: 4          # ç»´åº¦é™¤æ•° (dim // 4)
      
      # 1Dä½ç½®ç¼–ç  (ç”¨äºåºåˆ—) 
      pos_1d:
        max_seq_len: 1000       # æœ€å¤§åºåˆ—é•¿åº¦
        learnable: false        # æ˜¯å¦å¯å­¦ä¹ 

# =============================================================================
# æ•°æ®é…ç½® - æ•°æ®åŠ è½½å’Œå¢å¼º
# =============================================================================
data:
  # æ•°æ®é›†è®¾ç½®
  dataset:
    data_root: "sim_data"
    
  # 3Dåæ ‡å’Œå°ºå¯¸èŒƒå›´ (åŸå§‹ç‰©ç†æ•°å€¼ï¼Œä¸åšå½’ä¸€åŒ–)
  continuous_ranges:
    x: [0.5, 2.5]
    y: [-2.0, 2.0] 
    z: [-1.5, 1.5]
    w: [0.3, 0.7]
    h: [0.3, 0.7]
    l: [0.3, 0.7]
  
  # DataLoaderè®¾ç½®
  dataloader:
    batch_size: 4  # ğŸ”§ å‡å°‘batch sizeè§£å†³CUDA OOMé—®é¢˜ï¼ˆä»16->4ï¼‰
    num_workers: 4
    pin_memory: true
    prefetch_factor: 2
    persistent_workers: true
    shuffle: true
    drop_last: true
  
  # æ•°æ®å¢å¼º
  augmentation:
    enabled: true
    intensity: 1.0
    
    # RGBå›¾åƒå¢å¼º
    rgb_enhancement:
      brightness:
        enabled: true
        probability: 0.7
        factor_range: [0.8, 1.2]  # äº®åº¦è°ƒæ•´èŒƒå›´
      contrast:
        enabled: true
        probability: 0.7
        factor_range: [0.8, 1.2]  # å¯¹æ¯”åº¦è°ƒæ•´èŒƒå›´
      saturation:
        enabled: true
        probability: 0.5
        factor_range: [0.8, 1.2]  # é¥±å’Œåº¦è°ƒæ•´èŒƒå›´
      hue:
        enabled: true
        probability: 0.3
        shift_range: [-10, 10]    # è‰²è°ƒåç§»èŒƒå›´
    
    # RGBå™ªå£°
    rgb_noise:
      gaussian:
        enabled: true
        probability: 0.6
        std_range: [2, 8]        # é«˜æ–¯å™ªå£°æ ‡å‡†å·®èŒƒå›´
      salt_pepper:
        enabled: true
        probability: 0.4
        ratio_range: [0.001, 0.01]  # æ¤’ç›å™ªå£°æ¯”ä¾‹èŒƒå›´
      speckle:
        enabled: true
        probability: 0.3
        std_range: [0.05, 0.15]  # æ–‘ç‚¹å™ªå£°æ ‡å‡†å·®èŒƒå›´
    
    # ç‚¹äº‘å¢å¼º
    point_cloud:
      enabled: true
      gaussian_noise:
        enabled: true
        probability: 0.7
        std_ranges:
          x: [0.001, 0.005]        # Xåæ ‡å™ªå£°æ ‡å‡†å·®èŒƒå›´
          y: [0.001, 0.005]        # Yåæ ‡å™ªå£°æ ‡å‡†å·®èŒƒå›´
          z: [0.001, 0.005]       # Zåæ ‡å™ªå£°æ ‡å‡†å·®èŒƒå›´
      dropout:
        enabled: true
        probability: 0.5
        ratio_range: [0.0001, 0.001]  # ç‚¹äº‘ä¸¢å¼ƒæ¯”ä¾‹èŒƒå›´
      quantization:
        enabled: false
        probability: 0.4
        step_range: [0.005, 0.02]   # é‡åŒ–æ­¥é•¿èŒƒå›´
      coordinate_bias:
        enabled: false
        probability: 0.3
        bias_ranges:
          x: [-0.02, 0.02]       # Xåæ ‡åç½®èŒƒå›´
          y: [-0.02, 0.02]       # Yåæ ‡åç½®èŒƒå›´
          z: [-0.01, 0.01]       # Zåæ ‡åç½®èŒƒå›´
    
    # 3D boxå¢å¼º
    box_augmentation:
      enabled: false
      probability: 0.2            # æ€»ä½“Boxå¢å¼ºæ¦‚ç‡
      position_noise:
        enabled: false
        probability: 0.8
        noise_ranges:
          x: [-0.02, 0.02]       # Xä½ç½®å™ªå£°èŒƒå›´
          y: [-0.02, 0.02]       # Yä½ç½®å™ªå£°èŒƒå›´ 
          z: [-0.01, 0.01]       # Zä½ç½®å™ªå£°èŒƒå›´
      size_noise:
        enabled: false
        probability: 0.6
        noise_ranges:
          w: [-0.01, 0.01]       # å®½åº¦å™ªå£°èŒƒå›´
          h: [-0.01, 0.01]       # é«˜åº¦å™ªå£°èŒƒå›´
          l: [-0.01, 0.01]       # é•¿åº¦å™ªå£°èŒƒå›´
    
    # å…¨å±€å¹³ç§»å¢å¼ºï¼ˆç‚¹äº‘å’Œboxä¸€èµ·å¹³ç§»ï¼‰
    global_translation:
      enabled: true
      probability: 0.5            # å…¨å±€å¹³ç§»æ¦‚ç‡
      translation_ranges:
        x: [-0.1, 0.1]           # Xæ–¹å‘å¹³ç§»èŒƒå›´
        y: [-0.1, 0.1]           # Yæ–¹å‘å¹³ç§»èŒƒå›´
        z: [-0.05, 0.05]         # Zæ–¹å‘å¹³ç§»èŒƒå›´ï¼ˆé€šå¸¸è¾ƒå°ï¼‰

# =============================================================================
# æŸå¤±å‡½æ•°é…ç½®
# =============================================================================
loss:
  name: "AdaptivePrimitiveTransformer3DLoss"
  version: "1.0"
  
  # æ•°æ®å¤„ç†
  data_processing:
    ignore_index: -100
    label_smoothing: 0.1        # æ ‡ç­¾å¹³æ»‘å‚æ•°
    pad_id: -1.0               # å¡«å……ID
  
  # ç®—æ³•å‚æ•°
  algorithm:
    # IoUè®¡ç®—å‚æ•°
    iou:
      epsilon: 0.0000001        # æ•°å€¼ç¨³å®šæ€§å‚æ•°
      temperature: 10.0         # sigmoidé™¡å³­ç¨‹åº¦
      sampling_resolution: 20   # é‡‡æ ·åˆ†è¾¨ç‡
    
    # è·ç¦»æ„ŸçŸ¥åˆ†ç±»
    distance_aware:
      enabled: true
      alpha: 2.0               # è·ç¦»æƒé‡å‚æ•°
    
    # Focal Loss
    focal:
      enabled: false
      gamma: 2.0               # focal loss gammaå‚æ•°
  
  # åŸºç¡€æƒé‡
  base_weights:
    classification: 1.0
    delta: 2.0
    eos: 2.0
    iou: 1.0
  
  # è‡ªé€‚åº”æƒé‡
  adaptive_weights:
    adaptive_classification: true
    adaptive_delta: true
    interpolation: "linear"
    
    thresholds:
      low: 0.3
      high: 0.7
    
    # åˆ†ç±»æƒé‡èŒƒå›´
    classification_range:
      min: 0.5
      max: 2.0
    
    # Deltaæƒé‡èŒƒå›´  
    delta_range:
      min: 0.5
      max: 2.0
  
  # IoUè®¡ç®—é…ç½®
  # iou_computation:
  #   projection_axes: 3
  #   projection_method: "multi_axis"
  #   enable_rotation: true
  #   min_area_threshold: 1e-6
    
  #   # 2DæŠ•å½±IoUè®¾ç½®
  #   grid_resolution: 100
  #   polygon_method: "shoelace"

# =============================================================================
# å®éªŒé…ç½® - æ—¥å¿—å’Œä¿å­˜
# =============================================================================
experiment:
  name: "primitive_3d_unified"
  description: "ç»Ÿä¸€é…ç½®çš„3Dç‰©ä½“æ£€æµ‹å®éªŒ"
  
  # æ£€æŸ¥ç‚¹é…ç½®
  checkpoints:
    save_dir: "experiments"
    save_latest: true
    save_best_val: true
    save_best_generation: true
    save_interval: null  # ä¸æŒ‰epoché—´éš”ä¿å­˜
  
  # éªŒè¯é…ç½®
  validation:
    interval: 1  # æ¯epochéªŒè¯
    samples: [0, 1, 2, 3, 4]  # éªŒè¯æ ·æœ¬ç´¢å¼•
    
  # æ—¥å¿—é…ç½®
  logging:
    use_swanlab: true
    log_interval: 10  # æ¯10ä¸ªbatchè®°å½•ä¸€æ¬¡
    save_model_graph: false
    log_gradients: false
    log_weights: false 
